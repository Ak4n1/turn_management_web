<div class="admin-appointments-container">
  <div class="management-main">
    <!-- Sidebar -->
    <aside class="management-sidebar">
      <div class="sidebar-header">
        <h1 class="management-title">Gestión de Turnos</h1>
        <p class="management-subtitle">Administra todos los turnos del sistema</p>
      </div>

      <!-- Búsqueda -->
      <div class="filter-card">
        <app-label for="search">BUSCAR</app-label>
        <div class="search-box">
          <i class="fas fa-search search-icon"></i>
          <input class="search-input" id="search" placeholder="Email, nombre..." type="text" [ngModel]="searchTerm"
            (ngModelChange)="searchTerm = $event" (keyup.enter)="onSearch()" />
        </div>
      </div>

      <!-- Filtro de Fecha -->
      <div class="filter-card">
        <app-label>RANGO DE FECHA</app-label>
        <div class="date-inputs">
          <div class="date-group">
            <span class="date-label">Desde</span>
            <input type="date" class="styled-date-input" [ngModel]="dateFrom"
              (ngModelChange)="dateFrom = $event; onDateFilterChange()" />
          </div>
          <div class="date-group">
            <span class="date-label">Hasta</span>
            <input type="date" class="styled-date-input" [ngModel]="dateTo"
              (ngModelChange)="dateTo = $event; onDateFilterChange()" [min]="dateFrom" />
          </div>
        </div>
      </div>

      <!-- Fecha concreta y Hoy -->
      <div class="filter-card">
        <app-label>VER UN DÍA</app-label>
        <div class="date-inputs date-single-row">
          <div class="date-group flex-1">
            <input type="date" class="styled-date-input" [ngModel]="singleDate"
              (ngModelChange)="onSingleDateChange($event)" aria-label="Fecha" />
          </div>
          <app-button variant="secondary" size="small" (clicked)="setTodayAndLoad()" class="btn-today">
            <i class="fas fa-calendar-day"></i> Hoy
          </app-button>
        </div>
      </div>

      <!-- Filtro Días de la Semana -->
      <div class="filter-card">
        <app-label>DÍAS DE LA SEMANA</app-label>
        <div class="day-chips">
          <button type="button" class="day-chip" [class.active]="selectedDaysOfWeek.size === 0"
            (click)="clearDaysOfWeek()">
            Todos
          </button>
          @for (day of [1, 2, 3, 4, 5, 6, 7]; track day) {
          <button type="button" class="day-chip" [class.active]="isDayOfWeekSelected(day)"
            (click)="toggleDayOfWeek(day)">
            {{ getDayName(day) }}
          </button>
          }
        </div>
      </div>

      <!-- Filtro por Estado -->
      <div class="filter-card border-none">
        <app-label>ESTADO DEL TURNO</app-label>
        <div class="state-filters">
          @for (state of stateOptions; track state) {
          <label class="state-filter-item">
            <div class="state-identifier">
              <div class="state-dot" [class]="getStateDotClass(state)"></div>
              <span class="state-name">{{ getStateLabel(state) }}</span>
            </div>
            <input type="checkbox" class="state-checkbox" [checked]="activeFilter === state"
              (change)="setFilter(activeFilter === state ? 'ALL' : state)" />
          </label>
          }

          <app-button variant="secondary" size="small" (clicked)="clearFilters()" class="w-full mt-4">
            <i class="fas fa-undo"></i> Limpiar Filtros
          </app-button>
        </div>
      </div>
    </aside>

    <!-- Appointment List Area -->
    <section class="appointments-area">
      <div class="area-header">
        <div class="view-tabs">
          <button type="button" class="view-tab" [class.active]="viewMode === 'appointments'"
            (click)="setViewMode('appointments')">
            <i class="fas fa-calendar-alt"></i> Turnos registrados
          </button>
          <button type="button" class="view-tab" [class.active]="viewMode === 'reschedule-requests'"
            (click)="setViewMode('reschedule-requests')">
            <i class="fas fa-clock-rotate-left"></i> Reprogramaciones solicitadas
            @if (rescheduleRequestsTotal > 0 && viewMode === 'appointments') {
            <span class="tab-badge">{{ rescheduleRequestsTotal }}</span>
            }
          </button>
        </div>
        <div class="header-info" *ngIf="viewMode === 'appointments'">
          <span class="result-badge">{{ totalElements }} turnos</span>
        </div>
        <div class="header-info" *ngIf="viewMode === 'reschedule-requests'">
          <span class="result-badge">{{ rescheduleRequestsTotal }} solicitudes pendientes</span>
        </div>
      </div>

      <!-- Vista: Reprogramaciones solicitadas -->
      @if (viewMode === 'reschedule-requests') {
      <div class="appointments-content">
        @if (rescheduleRequestsLoading) {
        <div class="loading-container">
          <app-spinner></app-spinner>
          <p>Cargando solicitudes...</p>
        </div>
        } @else if (rescheduleRequestsError) {
        <div class="error-container">
          <app-error-text [message]="rescheduleRequestsError"></app-error-text>
        </div>
        } @else if (rescheduleRequests.length === 0) {
        <div class="empty-container">
          <i class="fas fa-inbox empty-icon"></i>
          <p>No hay reprogramaciones pendientes de aprobación.</p>
        </div>
        } @else {
        <div class="reschedule-requests-list">
          @for (req of rescheduleRequests; track req.id) {
          <div class="reschedule-request-card">
            <div class="reschedule-request-main">
              <div class="reschedule-user">
                <span class="reschedule-user-name">{{ getRescheduleRequestUserName(req) }}</span>
                <span class="reschedule-user-email">{{ req.userEmail }}</span>
              </div>
              <div class="reschedule-dates">
                <div class="reschedule-from">
                  <span class="reschedule-label">Turno actual</span>
                  <span>{{ req.currentDate }} {{ req.currentStartTime }}</span>
                </div>
                <i class="fas fa-arrow-right reschedule-arrow"></i>
                <div class="reschedule-to">
                  <span class="reschedule-label">Solicitado</span>
                  <span>{{ req.requestedDate }} {{ req.requestedStartTime }}</span>
                </div>
              </div>
              @if (req.reason) {
              <p class="reschedule-reason"><strong>Motivo:</strong> {{ req.reason }}</p>
              }
            </div>
            <div class="reschedule-request-actions">
              <app-button variant="primary" size="small" [disabled]="rescheduleRequestActionLoading !== null"
                (clicked)="onApproveRescheduleRequest(req)">
                @if (rescheduleRequestActionLoading === req.id) {
                <app-spinner></app-spinner>
                } @else {
                <i class="fas fa-check"></i> Aprobar
                }
              </app-button>
              <app-button variant="secondary" size="small" [disabled]="rescheduleRequestActionLoading !== null"
                (clicked)="openRejectRescheduleModal(req)">
                <i class="fas fa-times"></i> Rechazar
              </app-button>
            </div>
          </div>
          }
        </div>
        @if (rescheduleRequestsTotalPages > 1) {
        <div class="modern-pagination">
          <app-button variant="secondary" size="medium" [disabled]="rescheduleRequestsPage === 0"
            (clicked)="rescheduleRequestsPage = rescheduleRequestsPage - 1; loadRescheduleRequests()">
            <i class="fas fa-chevron-left"></i> Anterior
          </app-button>
          <div class="pag-info">
            Página <strong>{{ rescheduleRequestsPage + 1 }}</strong> de {{ rescheduleRequestsTotalPages }}
          </div>
          <app-button variant="secondary" size="medium"
            [disabled]="rescheduleRequestsPage >= rescheduleRequestsTotalPages - 1"
            (clicked)="rescheduleRequestsPage = rescheduleRequestsPage + 1; loadRescheduleRequests()">
            Siguiente <i class="fas fa-chevron-right"></i>
          </app-button>
        </div>
        }
        }
      </div>
      }

      <!-- Vista: Turnos registrados -->
      @if (viewMode === 'appointments') {
      <div class="appointments-content">
        @if (isLoading) {
        <div class="loading-container">
          <app-spinner></app-spinner>
          <p>Cargando turnos...</p>
        </div>
        } @else if (error) {
        <div class="error-container">
          <app-error-text [message]="error"></app-error-text>
        </div>
        } @else if (appointments.length === 0) {
        <div class="empty-container">
          <i class="fas fa-calendar-times empty-icon"></i>
          <p>No se encontraron turnos para los criterios seleccionados.</p>
        </div>
        } @else {
        <div class="appointments-grid">
          @for (appointment of appointments; track appointment.id) {
          <div class="modern-appointment-card" [class]="appointment.state.toLowerCase()"
            [class.appointment-past]="isPastDate(appointment)">
            <div class="card-main">
              <div class="card-user-info">
                <div class="user-avatar-placeholder user-initials">
                  <span class="user-initials-text">{{ getUserInitials(appointment) }}</span>
                </div>
                <div class="user-text">
                  <h3 class="user-name">{{ getUserName(appointment) }}</h3>
                  <p class="service-name">{{ appointment.userEmail }}</p>
                  <span class="status-badge-below-email" [class]="getStateBadgeClass(appointment.state)">
                    <span class="badge-dot"></span>
                    {{ getStateLabel(appointment.state) }}
                  </span>
                </div>
              </div>
              <div class="card-time-info">
                <span class="time-main">{{ appointment.startTime }}</span>
                <span class="time-period">{{ appointment.startTime < '12:00' ? 'A.M.' : 'P.M.' }}</span>
              </div>
            </div>

            <div class="card-footer">
              <div class="footer-badges">
                <span class="info-tag">
                  <i class="fas fa-calendar-day"></i>
                  {{ formatDate(appointment.date) }}
                </span>
              </div>

              <div class="card-actions">
                <button class="action-btn export" (click)="exportToPdf(appointment)" title="Exportar PDF">
                  <i class="fas fa-file-pdf"></i>
                </button>
                <button class="action-btn" (click)="viewDetails(appointment.id)" title="Ver Detalles">
                  <i class="fas fa-eye"></i>
                </button>
                @if (appointment.state === 'CONFIRMED' || appointment.state === 'CREATED') {
                <button class="action-btn" (click)="rescheduleAppointment(appointment.id)" title="Reprogramar">
                  <i class="fas fa-clock-rotate-left"></i>
                </button>
                <button class="action-btn danger" (click)="cancelAppointment(appointment.id)" title="Cancelar">
                  <i class="fas fa-times-circle"></i>
                </button>
                }
              </div>
            </div>
          </div>
          }
        </div>

        <!-- Paginación -->
        @if (totalPages > 1) {
        <div class="modern-pagination">
          <app-button variant="secondary" size="medium" [disabled]="currentPage === 0"
            (clicked)="goToPage(currentPage - 1)">
            <i class="fas fa-chevron-left"></i> Anterior
          </app-button>
          <div class="pag-info">
            Página <strong>{{ currentPage + 1 }}</strong> de {{ totalPages }}
          </div>
          <app-button variant="secondary" size="medium" [disabled]="currentPage >= totalPages - 1"
            (clicked)="goToPage(currentPage + 1)">
            Siguiente <i class="fas fa-chevron-right"></i>
          </app-button>
        </div>
        }
        }
      </div>
      }
    </section>
  </div>

  <!-- Modal rechazar reprogramación -->
  @if (selectedRescheduleRequestToReject) {
  <div class="modal-overlay" (click)="closeRejectRescheduleModal()">
    <div class="modal-box reject-modal" (click)="$event.stopPropagation()">
      <h3 class="modal-title">Rechazar solicitud de reprogramación</h3>
      <p class="modal-text">
        ¿Motivo del rechazo? (opcional)
      </p>
      <textarea class="reject-reason-input" rows="3" [(ngModel)]="rejectReason"
        placeholder="Ej: El horario solicitado no está disponible."></textarea>
      <div class="modal-actions">
        <app-button variant="secondary" size="medium" (clicked)="closeRejectRescheduleModal()">
          Cancelar
        </app-button>
        <app-button variant="primary" size="medium" [disabled]="rescheduleRequestActionLoading !== null"
          (clicked)="onRejectRescheduleRequest()">
          @if (rescheduleRequestActionLoading === selectedRescheduleRequestToReject.id) {
          <app-spinner></app-spinner>
          } @else {
          Rechazar
          }
        </app-button>
      </div>
    </div>
  </div>
  }

  <!-- Modales Existentes (Mantenidos) -->
  <app-appointment-details-modal [isOpen]="isDetailsModalOpen" [appointment]="selectedAppointment"
    (close)="onDetailsModalClose()">
  </app-appointment-details-modal>

  <app-reschedule-modal [isOpen]="isRescheduleModalOpen" [appointment]="selectedAppointment"
    (close)="onRescheduleModalClose()" (rescheduled)="onRescheduled($event)">
  </app-reschedule-modal>

  <app-cancel-modal [isOpen]="isCancelModalOpen" [appointment]="selectedAppointment" (close)="onCancelModalClose()"
    (cancelled)="onCancelled($event)">
  </app-cancel-modal>
</div>