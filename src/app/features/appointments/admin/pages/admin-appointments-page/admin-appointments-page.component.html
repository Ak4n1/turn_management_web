<div class="admin-appointments-container">
  <div class="management-main">
    <!-- Sidebar -->
    <aside class="management-sidebar">
      <div class="sidebar-header">
        <h1 class="management-title">Gestión de Turnos</h1>
        <p class="management-subtitle">Administra todos los turnos del sistema</p>
      </div>

      <!-- Búsqueda -->
      <div class="filter-card">
        <app-label for="search">BUSCAR</app-label>
        <div class="search-box">
          <i class="fas fa-search search-icon"></i>
          <input class="search-input" id="search" placeholder="Email, nombre..." type="text" [ngModel]="searchTerm"
            (ngModelChange)="searchTerm = $event" (keyup.enter)="onSearch()" />
        </div>
      </div>

      <!-- Filtro de Fecha -->
      <div class="filter-card">
        <app-label>RANGO DE FECHA</app-label>
        <div class="date-inputs">
          <div class="date-group">
            <span class="date-label">Desde</span>
            <input type="date" class="styled-date-input" [ngModel]="dateFrom"
              (ngModelChange)="dateFrom = $event; onDateFilterChange()" />
          </div>
          <div class="date-group">
            <span class="date-label">Hasta</span>
            <input type="date" class="styled-date-input" [ngModel]="dateTo"
              (ngModelChange)="dateTo = $event; onDateFilterChange()" [min]="dateFrom" />
          </div>
        </div>
      </div>

      <!-- Filtro Días de la Semana -->
      <div class="filter-card">
        <app-label>DÍAS DE LA SEMANA</app-label>
        <div class="day-chips">
          <button type="button" class="day-chip" [class.active]="selectedDaysOfWeek.size === 0"
            (click)="clearDaysOfWeek()">
            Todos
          </button>
          @for (day of [1, 2, 3, 4, 5, 6, 7]; track day) {
          <button type="button" class="day-chip" [class.active]="isDayOfWeekSelected(day)"
            (click)="toggleDayOfWeek(day)">
            {{ getDayName(day) }}
          </button>
          }
        </div>
      </div>

      <!-- Filtro por Estado -->
      <div class="filter-card border-none">
        <app-label>ESTADO DEL TURNO</app-label>
        <div class="state-filters">
          @for (state of stateOptions; track state) {
          <label class="state-filter-item">
            <div class="state-identifier">
              <div class="state-dot" [class]="getStateDotClass(state)"></div>
              <span class="state-name">{{ getStateLabel(state) }}</span>
            </div>
            <input type="checkbox" class="state-checkbox" [checked]="activeFilter === state"
              (change)="setFilter(activeFilter === state ? 'ALL' : state)" />
          </label>
          }

          <app-button variant="secondary" size="small" (clicked)="clearFilters()" class="w-full mt-4">
            <i class="fas fa-undo"></i> Limpiar Filtros
          </app-button>
        </div>
      </div>
    </aside>

    <!-- Appointment List Area -->
    <section class="appointments-area">
      <div class="area-header">
        <div class="header-info">
          <h2 class="area-title">Turnos Registrados</h2>
          <span class="result-badge">{{ totalElements }} turnos</span>
        </div>
      </div>

      <div class="appointments-content">
        @if (isLoading) {
        <div class="loading-container">
          <app-spinner></app-spinner>
          <p>Cargando turnos...</p>
        </div>
        } @else if (error) {
        <div class="error-container">
          <app-error-text [message]="error"></app-error-text>
        </div>
        } @else if (appointments.length === 0) {
        <div class="empty-container">
          <i class="fas fa-calendar-times empty-icon"></i>
          <p>No se encontraron turnos para los criterios seleccionados.</p>
        </div>
        } @else {
        <div class="appointments-grid">
          @for (appointment of appointments; track appointment.id) {
          <div class="modern-appointment-card" [class]="appointment.state.toLowerCase()">
            <div class="card-main">
              <div class="card-user-info">
                <div class="user-avatar-placeholder user-initials">
                  <span class="user-initials-text">{{ getUserInitials(appointment) }}</span>
                </div>
                <div class="user-text">
                  <h3 class="user-name">{{ getUserName(appointment) }}</h3>
                  <p class="service-name">{{ appointment.userEmail }}</p>
                </div>
              </div>
              <div class="card-time-info">
                <span class="time-main">{{ appointment.startTime }}</span>
                <span class="time-period">{{ appointment.startTime < '12:00' ? 'A.M.' : 'P.M.' }}</span>
              </div>
            </div>

            <div class="card-footer">
              <div class="footer-badges">
                <span class="footer-badge" [class]="getStateBadgeClass(appointment.state)">
                  <div class="badge-dot"></div>
                  {{ getStateLabel(appointment.state) }}
                </span>
                <span class="info-tag">
                  <i class="fas fa-calendar-day"></i>
                  {{ formatDate(appointment.date) }}
                </span>
              </div>

              <div class="card-actions">
                <button class="action-btn export" (click)="exportToPdf(appointment)" title="Exportar PDF">
                  <i class="fas fa-file-pdf"></i>
                </button>
                <button class="action-btn" (click)="viewDetails(appointment.id)" title="Ver Detalles">
                  <i class="fas fa-eye"></i>
                </button>
                @if (appointment.state === 'CONFIRMED' || appointment.state === 'CREATED') {
                <button class="action-btn" (click)="rescheduleAppointment(appointment.id)" title="Reprogramar">
                  <i class="fas fa-clock-rotate-left"></i>
                </button>
                <button class="action-btn danger" (click)="cancelAppointment(appointment.id)" title="Cancelar">
                  <i class="fas fa-times-circle"></i>
                </button>
                }
              </div>
            </div>
          </div>
          }
        </div>

        <!-- Paginación -->
        @if (totalPages > 1) {
        <div class="modern-pagination">
          <app-button variant="secondary" size="medium" [disabled]="currentPage === 0"
            (clicked)="goToPage(currentPage - 1)">
            <i class="fas fa-chevron-left"></i> Anterior
          </app-button>
          <div class="pag-info">
            Página <strong>{{ currentPage + 1 }}</strong> de {{ totalPages }}
          </div>
          <app-button variant="secondary" size="medium" [disabled]="currentPage >= totalPages - 1"
            (clicked)="goToPage(currentPage + 1)">
            Siguiente <i class="fas fa-chevron-right"></i>
          </app-button>
        </div>
        }
        }
      </div>
    </section>
  </div>

  <!-- Modales Existentes (Mantenidos) -->
  <app-appointment-details-modal [isOpen]="isDetailsModalOpen" [appointment]="selectedAppointment"
    (close)="onDetailsModalClose()">
  </app-appointment-details-modal>

  <app-reschedule-modal [isOpen]="isRescheduleModalOpen" [appointment]="selectedAppointment"
    (close)="onRescheduleModalClose()" (rescheduled)="onRescheduled($event)">
  </app-reschedule-modal>

  <app-cancel-modal [isOpen]="isCancelModalOpen" [appointment]="selectedAppointment" (close)="onCancelModalClose()"
    (cancelled)="onCancelled($event)">
  </app-cancel-modal>
</div>