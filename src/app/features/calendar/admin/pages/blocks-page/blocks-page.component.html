<div class="blocks-page">
  <div class="page-header">
    <div class="header-content">
      <div>
        <h1 class="page-title">Bloqueos Operativos</h1>
        <p class="page-subtitle">Gestiona bloqueos operativos del calendario (mantenimiento, reuniones, etc.)</p>
      </div>
      <div class="help-button-container">
        <app-button
          type="button"
          variant="secondary"
          size="medium"
          (clicked)="toggleInfo()"
          ariaLabel="Ayuda sobre bloqueos y excepciones">
          <i class="fas fa-question-circle" aria-hidden="true"></i>
          Ayuda
        </app-button>
      </div>
    </div>
  </div>

  <!-- Info Alert -->
  @if (showInfo) {
    <div class="info-alert">
      <div class="info-header">
        <i class="fas fa-info-circle"></i>
        <h3>¿Cuál es la diferencia entre Bloqueos y Excepciones?</h3>
        <app-button
          type="button"
          variant="text"
          size="small"
          (clicked)="toggleInfo()"
          ariaLabel="Cerrar información">
          <i class="fas fa-times" aria-hidden="true"></i>
        </app-button>
      </div>
      <div class="info-content">
        <div class="info-section">
          <h4><i class="fas fa-ban"></i> Bloqueos Operativos</h4>
          <ul>
            <li><strong>Prioridad máxima:</strong> Tienen prioridad sobre todas las reglas (base, excepciones, etc.)</li>
            <li><strong>Uso:</strong> Mantenimiento, reuniones internas, emergencias operativas</li>
            <li><strong>Rango horario:</strong> Un solo rango horario o día completo</li>
            <li><strong>Afecta turnos:</strong> Puede afectar turnos existentes (opción configurable)</li>
            <li><strong>Restrictivo:</strong> Bloquea completamente la disponibilidad</li>
          </ul>
        </div>
        <div class="info-section">
          <h4><i class="fas fa-calendar-alt"></i> Excepciones</h4>
          <ul>
            <li><strong>Prioridad media:</strong> Tienen prioridad sobre reglas base, pero no sobre bloqueos</li>
            <li><strong>Uso:</strong> Días especiales, horarios reducidos, feriados, aperturas especiales</li>
            <li><strong>Rangos horarios:</strong> Múltiples rangos horarios permitidos</li>
            <li><strong>Afecta turnos:</strong> No tiene opción de afectar turnos existentes</li>
            <li><strong>Flexible:</strong> Permite abrir o cerrar días específicos</li>
          </ul>
        </div>
        <div class="info-example">
          <strong>Ejemplo:</strong> Si tienes una excepción que abre un sábado, pero luego creas un bloqueo para ese mismo sábado, el bloqueo tendrá prioridad y el día quedará cerrado.
        </div>
      </div>
    </div>
  }

  <div class="page-actions">
    <app-button
      type="button"
      [variant]="showForm ? 'danger' : 'primary'"
      size="medium"
      (clicked)="toggleForm()">
      <i class="fas fa-plus" aria-hidden="true"></i>
      {{ showForm ? 'Cancelar' : 'Nuevo Bloqueo' }}
    </app-button>
  </div>

  @if (successMessage) {
    <div class="success-message">
      <i class="fas fa-check-circle"></i>
      <span>{{ successMessage }}</span>
    </div>
  }

  @if (error) {
    <div class="error-message">
      <app-error-text [message]="error"></app-error-text>
    </div>
  }

  <!-- Formulario -->
  @if (showForm) {
    <div class="form-section">
      <h2 class="form-title">Crear Nuevo Bloqueo</h2>
      
      <div class="form-group">
        <app-label for="date" [required]="true">Fecha</app-label>
        <app-date-input
          id="date"
          name="date"
          [ngModel]="formDate"
          (ngModelChange)="formDate = $event"
          [min]="getTodayDate()"
          [required]="true"
          [disabled]="isLoading">
        </app-date-input>
      </div>

      <div class="form-group">
        <app-label [required]="true">Tipo de bloqueo</app-label>
        <div class="radio-group">
          <label class="radio-label">
            <input
              type="radio"
              name="isFullDay"
              [(ngModel)]="formIsFullDay"
              [value]="true"
              [disabled]="isLoading">
            <span>Día completo</span>
          </label>
          <label class="radio-label">
            <input
              type="radio"
              name="isFullDay"
              [(ngModel)]="formIsFullDay"
              [value]="false"
              [disabled]="isLoading">
            <span>Rango horario</span>
          </label>
        </div>
      </div>

      @if (!formIsFullDay) {
        <div class="form-group">
          <app-label [required]="true">Rango Horario</app-label>
          <div class="time-range-row">
            <input
              type="time"
              class="time-input"
              [(ngModel)]="formTimeRange.start"
              [disabled]="isLoading">
            <span class="time-separator">-</span>
            <input
              type="time"
              class="time-input"
              [(ngModel)]="formTimeRange.end"
              [disabled]="isLoading">
          </div>
        </div>
      }

      <div class="form-group">
        <app-label for="reason" [required]="true">Motivo</app-label>
        <app-textarea
          id="reason"
          name="reason"
          [ngModel]="formReason"
          (ngModelChange)="formReason = $event"
          [rows]="3"
          placeholder="Describe el motivo del bloqueo (mínimo 10 caracteres)..."
          [required]="true"
          [maxLength]="500"
          [disabled]="isLoading">
        </app-textarea>
        <p class="form-hint">Mínimo 10 caracteres, máximo 500</p>
      </div>

      <div class="form-group">
        <label class="checkbox-label">
          <input
            type="checkbox"
            [(ngModel)]="formAffectsExisting"
            [disabled]="isLoading">
          <span>Afectar turnos existentes</span>
        </label>
        <p class="form-hint">Si está marcado, se permitirá crear el bloqueo aunque haya turnos afectados</p>
      </div>

      <div class="form-actions">
        <app-button
          type="button"
          variant="primary"
          size="medium"
          [disabled]="isLoading"
          [loading]="isLoading"
          (clicked)="submitForm()">
          <i class="fas fa-save" aria-hidden="true"></i>
          Crear Bloqueo
        </app-button>
      </div>
    </div>
  }

  <!-- Lista de Bloqueos -->
  <div class="exceptions-list">
    <h2 class="section-title">Bloqueos Existentes</h2>

    @if (isLoading && blocks.length === 0) {
      <div class="loading-state">
        <app-spinner></app-spinner>
        <p>Cargando bloqueos...</p>
      </div>
    } @else if (blocks.length === 0) {
      <div class="empty-state">
        <i class="fas fa-inbox"></i>
        <p>No hay bloqueos configurados</p>
      </div>
    } @else {
      <div class="exceptions-grid">
        @for (block of blocks; track block.id) {
          <div class="exception-card block-card" [class.full-day]="block.isFullDay" [class.partial]="!block.isFullDay">
            <div class="card-header">
              <h3 class="card-title">{{ formatDate(block.blockDate) }}</h3>
              <span class="card-badge" [class.full-day]="block.isFullDay" [class.partial]="!block.isFullDay">
                {{ block.isFullDay ? 'Día completo' : 'Parcial' }}
              </span>
            </div>
            <div class="card-body">
              <p class="card-reason"><strong>Motivo:</strong> {{ block.reason }}</p>
              <p class="card-time"><strong>Horario:</strong> {{ formatTimeRange(block) }}</p>
              @if (block.affectsExistingAppointments) {
                <p class="card-warning">
                  <i class="fas fa-exclamation-triangle"></i>
                  Afecta turnos existentes
                </p>
              }
              <p class="card-meta">
                <i class="fas fa-calendar"></i>
                Creado: {{ formatDate(block.createdAt) }}
              </p>
            </div>
          </div>
        }
      </div>
    }
  </div>
</div>

