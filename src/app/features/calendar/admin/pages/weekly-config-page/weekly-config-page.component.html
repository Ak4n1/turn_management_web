<div class="weekly-config-page">
  <div class="rules-content">
    <!-- Page Header - Estilo code.html -->
    <header class="rules-header">
      <div class="rules-header-text">
        <h1 class="rules-title">Reglas de Atención</h1>
        <p class="rules-subtitle">Configura los días, horarios y parámetros de tu servicio.</p>
      </div>
      <div class="rules-header-actions">
        <app-button variant="primary" (clicked)="saveAll()" [disabled]="isLoading || isSavingAll"
          [loading]="isSavingAll">
          Guardar Cambios
        </app-button>
      </div>
    </header>

    @if (isLoading && !activeConfig) {
    <div class="loading-state">
      <app-spinner></app-spinner>
      <p>Cargando configuración...</p>
    </div>
    } @else if (error && !activeConfig) {
    <div class="error-state">
      <app-error-text [message]="error"></app-error-text>
    </div>
    } @else {
    <!-- Step: Turnos Afectados -->
    @if (currentStep === 'affected-appointments' && affectedImpact) {
    <div class="affected-appointments-step">
      <!-- Header Section -->
      <div class="affected-header">
        <div class="affected-header-content">
          <div class="affected-warning-icon-wrapper">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <div>
            <h2 class="affected-title">Turnos Futuros Afectados</h2>
            <p class="affected-subtitle">Revisa y gestiona los turnos que se verían afectados por este cambio de
              configuración</p>
          </div>
        </div>
      </div>

      <!-- Stats Grid -->
      <div class="affected-stats-grid">
        <div class="affected-stat-card">
          <div class="affected-stat-label">Turnos Afectados</div>
          <div class="affected-stat-value">{{ affectedImpact.existingAppointmentsAffected }}</div>
        </div>
        <div class="affected-stat-card">
          <div class="affected-stat-label">Días Afectados</div>
          <div class="affected-stat-value">{{ affectedImpact.affectedDays }}</div>
        </div>
        <div class="affected-stat-card">
          <div class="affected-stat-label">Slots Perdidos</div>
          <div class="affected-stat-value">{{ affectedImpact.slotsLost }}</div>
        </div>
      </div>

      <!-- List Section -->
      <div class="affected-list-section">
        <h3 class="affected-list-title">
          <i class="fas fa-list-alt"></i>
          Detalle de Turnos
        </h3>

        <div class="affected-appointments-list">
          @if (affectedAppointmentsPaginated.length > 0) {
          @for (appointment of affectedAppointmentsPaginated; track appointment.id || appointment.date +
          appointment.time) {
          <div class="affected-appointment-item">
            <div class="affected-appointment-main">
              <div class="affected-user-avatar">
                {{ getAffectedAppointmentUserInitials(appointment) }}
              </div>
              <div>
                <h3 class="affected-user-name">{{ getAffectedAppointmentUserFullName(appointment) }}</h3>
                <p class="affected-date">{{ formatAffectedAppointmentDate(appointment) }}</p>
              </div>
            </div>
            <div class="affected-time-wrapper">
              <div class="affected-time-badge">{{ formatAffectedAppointmentTime(appointment) }}</div>
            </div>
          </div>
          }
          } @else {
          <div class="affected-empty-message">No hay turnos para mostrar.</div>
          }
        </div>

        <!-- Pagination -->
        @if (affectedAppointmentsTotalPages > 1) {
        <div class="affected-pagination">
          <button type="button" class="affected-pagination-btn" [disabled]="affectedAppointmentsCurrentPage === 0"
            (click)="affectedAppointmentsPreviousPage()">
            <i class="fas fa-chevron-left"></i>
          </button>

          <span class="affected-pagination-info">
            {{ affectedAppointmentsCurrentPage + 1 }} / {{ affectedAppointmentsTotalPages }}
          </span>

          <button type="button" class="affected-pagination-btn"
            [disabled]="affectedAppointmentsCurrentPage === affectedAppointmentsTotalPages - 1"
            (click)="affectedAppointmentsNextPage()">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
        }
      </div>

      <!-- Settings Section -->
      <div class="affected-settings-section">
        <div class="affected-settings-header">
          <div class="affected-settings-info">
            <h3 class="affected-settings-title">Cancelar automáticamente</h3>
            <p class="affected-settings-description">Si está activado, los turnos afectados se cancelarán y se
              notificará a los usuarios por email.</p>
          </div>
          <label class="switch">
            <input type="checkbox" [(ngModel)]="autoCancelAffectedAppointments">
            <span class="slider round"></span>
          </label>
        </div>

        @if (autoCancelAffectedAppointments) {
        <div class="affected-reason-container">
          <label class="affected-reason-label">Razón de la cancelación (personalizable)</label>
          <textarea class="affected-reason-textarea" [(ngModel)]="cancellationReason" rows="3"
            placeholder="Escribe el motivo...">
            </textarea>
          <p class="affected-reason-hint">
            <i class="fas fa-info-circle"></i>
            Esta razón será incluida en el email que se enviará a los usuarios afectados.
          </p>
        </div>
        }
      </div>

      <!-- Info Box -->
      <div class="affected-info-box">
        <i class="fas fa-info-circle affected-info-icon"></i>
        <p class="affected-info-text">
          @if (autoCancelAffectedAppointments) {
          <strong>Nota:</strong> Los turnos afectados serán gestionados automáticamente al confirmar. Asegúrate de haber
          revisado la lista antes de continuar.
          } @else {
          <strong>Nota:</strong> Los turnos existentes mantendrán su versión original de configuración, pero los nuevos
          turnos usarán la nueva configuración.
          }
          <span class="affected-question">¿Deseas continuar con el guardado?</span>
        </p>
      </div>

      <!-- Actions -->
      <div class="affected-page-actions">
        <button type="button" class="affected-btn-cancel" (click)="cancelAffectedAppointmentsStep()">
          <i class="fas fa-times"></i>
          Cancelar
        </button>
        <button type="button" class="affected-btn-confirm" [disabled]="isSavingAll"
          (click)="confirmAffectedAppointmentsStep()">
          <i class="fas fa-check-circle"></i>
          Continuar con el Guardado
        </button>
      </div>
    </div>
    }

    <!-- Step: Configuration - Layout 2 columnas (7+5) estilo code.html -->
    @if (currentStep === 'config') {
    <div class="config-grid">
      <!-- Columna izquierda (7 cols) -->
      <div class="config-col-left">
        <!-- Horarios de la Semana -->
        <div class="rules-card schedule-card">
          <div class="rules-card-header">
            <h2 class="rules-card-title">
              <i class="fas fa-calendar-alt rules-icon-primary"></i>
              Horarios de la Semana
            </h2>
          </div>
          <div class="days-list">
            @for (day of ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday']; track day) {
            <div class="day-row" [class.day-row-inactive]="!getDayValue(day)">
              <div class="day-info">
                <label class="switch">
                  <input type="checkbox" [ngModel]="getDayValue(day)" (ngModelChange)="setDayValue(day, $event)"
                    [disabled]="isLoading">
                  <span class="slider"></span>
                </label>
                <span class="day-name">{{ getDayName(day) }}</span>
              </div>

              @if (getDayValue(day)) {
              <div class="day-ranges">
                @for (range of dailyHours[day]; track $index) {
                <div class="time-pill">
                  <input type="time" [(ngModel)]="range.start" (ngModelChange)="validateAllTimeRanges()"
                    [disabled]="isLoading" class="time-input" [name]="'start-' + day + '-' + $index">
                  <span class="time-separator">–</span>
                  <input type="time" [(ngModel)]="range.end" (ngModelChange)="validateAllTimeRanges()"
                    [disabled]="isLoading" class="time-input" [name]="'end-' + day + '-' + $index">
                  <button type="button" class="time-pill-remove" (click)="removeTimeRange(day, $index)"
                    [disabled]="isLoading">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                }
                <button type="button" class="btn-add-range" (click)="addTimeRange(day)" [disabled]="isLoading">
                  <i class="fas fa-plus-circle"></i>
                  Añadir
                </button>
              </div>
              } @else {
              <span class="closed-status">Cerrado por defecto</span>
              }
            </div>
            }
          </div>
        </div>

      </div>

      <!-- Columna derecha (5 cols) -->
      <div class="config-col-right">
        <!-- Configuración Activa - Panel oscuro -->
        <div class="config-active-card">
          <div class="config-active-content">
            <h2 class="config-active-title">Configuración Activa</h2>
            <div class="config-active-rows">
              <div class="config-active-row">
                <span class="config-active-label">Versión del Sistema</span>
                <span class="config-active-value config-version">{{ activeConfig?.version ?? '—' }}</span>
              </div>
              <div class="config-active-row">
                <span class="config-active-label">Última actualización</span>
                <span class="config-active-value">{{ activeConfig ? formatDate(activeConfig.updatedAt) : '—' }}</span>
              </div>
              <div class="config-active-row">
                <span class="config-active-label">Duración de turnos</span>
                <div class="config-duration-wrap">
                  <input type="number" [(ngModel)]="appointmentDuration" name="appointmentDuration" [min]="15" [max]="240" [step]="15"
                    [disabled]="isLoading" class="config-duration-input">
                  <span class="config-duration-suffix">min</span>
                </div>
              </div>
            </div>
          </div>
          <div class="config-active-blur config-active-blur-1"></div>
          <div class="config-active-blur config-active-blur-2"></div>
        </div>

        <!-- Estados y Reglas -->
        <div class="rules-card states-card">
          <h3 class="states-title">
            <i class="fas fa-info-circle rules-icon-primary"></i>
            Estados y Reglas
          </h3>
          <div class="states-badges">
            <div class="state-badge state-open">
              <span>Abierto</span>
            </div>
            <div class="state-badge state-partial">
              <span>Parcial</span>
            </div>
            <div class="state-badge state-closed">
              <span>Cerrado</span>
            </div>
          </div>
          <div class="rules-explanations">
            <div class="rule-item">
              <div class="rule-badge rule-base">BASE</div>
              <div class="rule-text">
                <h4>Configuración Base</h4>
                <p>Horarios regulares que se repiten cada semana. Es la base de todo el calendario.</p>
              </div>
            </div>
            <div class="rule-item">
              <div class="rule-badge rule-excp">EXCP</div>
              <div class="rule-text">
                <h4>Excepciones</h4>
                <p>Modificaciones para días específicos (feriados, horarios reducidos). Tienen prioridad sobre la BASE.</p>
              </div>
            </div>
            <div class="rule-item">
              <div class="rule-badge rule-block">BLOCK</div>
              <div class="rule-text">
                <h4>Bloqueos</h4>
                <p>Máxima prioridad. Impide cualquier reserva sin importar la configuración base o excepción.</p>
              </div>
            </div>
          </div>
          <div class="rules-guide-wrap">
            <button type="button" class="btn-guide" (click)="openGuideModal()">
              <i class="fas fa-question-circle"></i>
              Guía Completa de Configuración
            </button>
          </div>
        </div>
      </div>
    </div>
    }

    <!-- Modal de Alerta (Success/Error/Warning) -->
    <app-alert-modal [isOpen]="isAlertModalOpen" [type]="alertType" [title]="alertTitle" [message]="alertMessage"
      [showCancelButton]="showCancelButton" cancelButtonText="Cancelar" confirmButtonText="Continuar"
      (close)="closeAlertModal()" (confirm)="onAlertConfirm()" (cancel)="closeAlertModal()">
    </app-alert-modal>

    <!-- Modal Guía Completa de Configuración (diseño tipo code.html) -->
    <app-modal [isOpen]="isGuideModalOpen" title="Guía de Configuración" headerClass="modal-header-info"
      size="large" (close)="closeGuideModal()">
      <div class="config-guide-wrap">
        <div class="config-guide-scroll">
          <section class="config-guide-section">
            <h2 class="config-guide-section-title">
              <i class="fas fa-layer-group config-guide-icon"></i>
              Prioridad de Reglas
            </h2>
            <div class="config-guide-priority-row">
              <div class="config-guide-priority-item">
                <span class="config-guide-dot config-guide-dot-block"></span>
                <span class="config-guide-priority-label">Bloqueo</span>
              </div>
              <i class="fas fa-chevron-right config-guide-chevron"></i>
              <div class="config-guide-priority-item">
                <span class="config-guide-dot config-guide-dot-exception"></span>
                <span class="config-guide-priority-label">Excepción</span>
              </div>
              <i class="fas fa-chevron-right config-guide-chevron"></i>
              <div class="config-guide-priority-item">
                <span class="config-guide-dot config-guide-dot-base"></span>
                <span class="config-guide-priority-label">Base</span>
              </div>
            </div>
            <p class="config-guide-note">El sistema procesa primero los bloqueos, luego las excepciones de fecha y finalmente el horario base semanal. Para cada día se aplica una sola regla en ese orden.</p>
          </section>

          <section class="config-guide-section">
            <h2 class="config-guide-section-title">
              <i class="fas fa-calendar-week config-guide-icon"></i>
              Configuración Base (Reglas de Atención)
            </h2>
            <ul class="config-guide-list">
              <li><span class="config-guide-bullet"></span> Define el patrón de trabajo semanal (lunes a domingo). Marca qué días están abiertos; los cerrados no tendrán horarios.</li>
              <li><span class="config-guide-bullet"></span> En cada día abierto puedes definir uno o varios rangos (ej. 09:00–12:00 y 14:00–18:00). Los rangos no pueden superponerse.</li>
              <li><span class="config-guide-bullet"></span> Debes guardar la configuración completa (semanal + horarios + duración) de una vez. Si algo falla (ej. duración no válida), no se guarda nada y la versión no cambia.</li>
            </ul>
          </section>

          <section class="config-guide-section config-guide-highlight">
            <h2 class="config-guide-section-title">
              <i class="fas fa-clock config-guide-icon"></i>
              Duración de Turnos
            </h2>
            <p class="config-guide-text">La duración de cada cita debe estar entre <strong class="config-guide-strong">15 y 240 minutos</strong> (4 horas).</p>
            <div class="config-guide-info-box">
              <i class="fas fa-info-circle config-guide-info-icon"></i>
              <p class="config-guide-info-text">Debe ser múltiplo de 15 (15, 30, 45, 60, 90, 120…) y debe <strong>dividir</strong> cada rango horario sin dejar resto. Ejemplo: rango 09:00–12:00 (180 min) admite 15, 30, 45, 60, 90, 180. No son válidos 25 ni 70.</p>
            </div>
          </section>

          <section class="config-guide-section">
            <h2 class="config-guide-section-title">
              <i class="fas fa-calendar-alt config-guide-icon"></i>
              Excepciones
            </h2>
            <ul class="config-guide-list">
              <li><span class="config-guide-bullet"></span> Días concretos con comportamiento distinto (feriados, horario reducido, apertura especial). Prioridad sobre la base, pero <strong>no</strong> sobre bloqueos.</li>
              <li><span class="config-guide-bullet"></span> Solo una excepción por fecha. No se puede crear una excepción en una fecha que ya tiene bloqueo.</li>
              <li><span class="config-guide-bullet"></span> Si el día está abierto por la excepción, debe tener al menos un rango horario; si está cerrado, no se definen rangos.</li>
            </ul>
          </section>

          <section class="config-guide-section">
            <h2 class="config-guide-section-title">
              <i class="fas fa-ban config-guide-icon"></i>
              Bloqueos Operativos
            </h2>
            <ul class="config-guide-list">
              <li><span class="config-guide-bullet"></span> Prioridad máxima: anulan cualquier disponibilidad en esa fecha o rango. Ni la base ni las excepciones se aplican en las franjas bloqueadas.</li>
              <li><span class="config-guide-bullet"></span> Uso: mantenimiento, reuniones internas, emergencias, cierre puntual.</li>
              <li><span class="config-guide-bullet"></span> Pueden ser día completo o un rango horario (un solo rango por bloqueo). Pueden afectar turnos existentes (opción al crear/editar).</li>
            </ul>
          </section>

          <section class="config-guide-section">
            <h2 class="config-guide-section-title">
              <i class="fas fa-th-list config-guide-icon"></i>
              Resumen de Reglas
            </h2>
            <div class="config-guide-cards">
              <div class="config-guide-card">
                <h3 class="config-guide-card-title">Exclusividad</h3>
                <p class="config-guide-card-text">No pueden existir dos excepciones que se solapen en el mismo día. Bloqueo &gt; Excepción &gt; Base siempre.</p>
              </div>
              <div class="config-guide-card">
                <h3 class="config-guide-card-title">Anulación</h3>
                <p class="config-guide-card-text">Un bloqueo anula cualquier disponibilidad base o excepción en esa fecha o franja horaria.</p>
              </div>
            </div>
            <ul class="config-guide-list config-guide-list-tight">
              <li><span class="config-guide-bullet"></span> Duración: 15–240 min, múltiplo de 15, que divida todos los rangos.</li>
              <li><span class="config-guide-bullet"></span> Solo los días abiertos en la base pueden tener horarios; rangos sin superponerse.</li>
            </ul>
          </section>
        </div>
        <div class="config-guide-footer">
          <button type="button" class="config-guide-btn" (click)="closeGuideModal()">Entendido</button>
        </div>
      </div>
    </app-modal>
    }

    <!-- Modal éxito guardar configuración (diseño tipo code.html) -->
    <app-config-saved-modal [isOpen]="isConfigSavedModalOpen" (close)="closeConfigSavedModal()">
    </app-config-saved-modal>
  </div>
</div>